---
title: "Influenza CITEseq"
author: "Neal Liu"
date: "2024-07-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

CITE-seq single cell data of baseline PBMC samples from 20 healthy individuals (10 high and 10 low responders) 
vaccinated with influenza pandemic H1N1 and seasonal vaccines in 2009.

Citation:
Kotliarov, Y., Sparks, R. et al. Broad immune activation underlies shared set point signatures 
for vaccine responsiveness in healthy individuals and disease activity in patients with lupus. 
Nat. Med. DOI: https://doi.org/10.1038/s41591-020-0769-8 (2020)


# Load libraries & our own helper functions
```{r}
library(SeuratObject)
library(Seurat)
library(tidyr)
library(cowplot)
library(dplyr)
library(ggplot2)
library(viridis)
library(mclust)
library(edgeR)
library(Rfast)
library(zellkonverter)
library(ADTnorm)
library(dsb)
library(harmony)
library(batchelor)
library(lisi)
library(ggpubr)
library(fastcluster)
library(BiocSingular)
#devtools::install('testPackage')
#library(testPackage)
#source('~/Edited_HelperFunctions_scMultiOmics_SuperFastRUVIIIPrPs.R')
source('testPackage/R/Sc_helper_functions.R')
devtools::source_url('https://raw.githubusercontent.com/Neal-Liu1/Multi-omics-integration/main/Helper_functions.R')


```

# Load and preprocess data
```{r}
data <- readRDS('/vast/scratch/users/liu.ne/20706645')

# Somehow the old seurat object doesnt line up the cells for RNA and ADT so we need to reorder them
processed_data <- lineup_samples(list(RNA = data@raw.data, ADT = data@assay$CITE@raw.data, Metadata = t(data@meta.data)))

```
# Create Metrics object and run all normalizations
```{r}
RNA_metrics <- BenchmarkMetrics(
  Algorithm = c('Raw_data', 'Seurat_LogNormalize', 'SCTransform','Seurat_CCA', 'Harmony','fastMNN', 'totalVI', 'RUVIII'),
  Raw_data = processed_data[['RNA']] %>% as.matrix(),
  Metadata = as.data.frame(t(processed_data[['Metadata']]))
  )

RNA_metrics <- FilterLowlyExpressedGenes(RNA_metrics, batch_variable = 'batch', n_not_detected_batch_to_permit = 0, ngenes_per_batch = 9000) %>% 
  NormalizeRNA() %>% 
  ComputeAssessments(variables = c('batch', 'K3'))


```
# Backup data
```{r}
# save.image(file= '/vast/scratch/users/liu.ne/Influenza_CITEseq_backup.RData')
# load('/vast/scratch/users/liu.ne/Influenza_CITEseq_backup.RData')

```




